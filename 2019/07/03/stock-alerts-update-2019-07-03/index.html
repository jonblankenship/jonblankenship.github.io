<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>Stock Alerts Update</title>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Stock Alerts Update | Jon Blankenship</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Stock Alerts Update" />
<meta name="author" content="Jon_Blankenship" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’d been meaning to get this update out over the weekend, but a stomach bug visited our house and threw off my schedule. I’d like to get these updates out about once a week going forward, but since this is a side project and I’m working on it for fun in my off hours, I’m not going to sweat it too much." />
<meta property="og:description" content="I’d been meaning to get this update out over the weekend, but a stomach bug visited our house and threw off my schedule. I’d like to get these updates out about once a week going forward, but since this is a side project and I’m working on it for fun in my off hours, I’m not going to sweat it too much." />
<link rel="canonical" href="https://blog.jonblankenship.com//2019/07/03/stock-alerts-update-2019-07-03/" />
<meta property="og:url" content="https://blog.jonblankenship.com//2019/07/03/stock-alerts-update-2019-07-03/" />
<meta property="og:site_name" content="Jon Blankenship" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-03T02:00:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://blog.jonblankenship.com//2019/07/03/stock-alerts-update-2019-07-03/","headline":"Stock Alerts Update","dateModified":"2019-07-03T02:00:00-05:00","datePublished":"2019-07-03T02:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.jonblankenship.com//2019/07/03/stock-alerts-update-2019-07-03/"},"author":{"@type":"Person","name":"Jon_Blankenship"},"description":"I’d been meaning to get this update out over the weekend, but a stomach bug visited our house and threw off my schedule. I’d like to get these updates out about once a week going forward, but since this is a side project and I’m working on it for fun in my off hours, I’m not going to sweat it too much.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  







<!-- Twitter cards -->
<meta name="twitter:site"    content="@Jon_Blankenship">
<meta name="twitter:creator" content="@Jon_Blankenship">
<meta name="twitter:title"   content="Stock Alerts Update">


<meta name="twitter:description" content="Developer.">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="">

<!-- end of Twitter cards -->


  <!-- Use $env:JEKYLL_ENV="production"; bundle exec jekyll build to build for production. -->
  <!-- Fathom - simple website analytics - https://usefathom.com -->
  <script>
      (function(f, a, t, h, o, m){
      a[h]=a[h]||function(){
          (a[h].q=a[h].q||[]).push(arguments)
      };
      o=f.createElement('script'),
      m=f.getElementsByTagName('script')[0];
      o.async=1; o.src=t; o.id='fathom-script';
      m.parentNode.insertBefore(o,m)
      })(document, window, '//cdn.usefathom.com/tracker.js', 'fathom');
      fathom('set', 'siteId', 'VHYCR');
      fathom('trackPageview');
  </script>
  <!-- / Fathom -->
</head>
<body>
  <header class="texture-black">
    <div class="container"></div><div class="container page-header post-header">
	<h1><a href="/">Jon Blankenship</a></h1>
	<h2>Developer.</h2>
</div>
	</header>
  <main>
    <div class="container">
      <div class="post-title">        
          <div class="post-date">
              Jul 3, 2019
            </div>
          <h1>Stock Alerts Update</h1>
          <h4 class="post-description"></h4>
      </div>

      <div class="post-container">
          <p>I’d been meaning to get this update out over the weekend, but a stomach bug visited our house and threw off my schedule. I’d like to get these updates out about once a week going forward, but since this is a side project and I’m working on it for fun in my off hours, I’m not going to sweat it too much.</p>

<!--more-->

<p>Also, as I mentioned in my <a href="https://blog.jonblankenship.com/2019/06/25/working-on-a-new-side-project-in-public/">first post</a>, these updates will be pretty informal and unpolished. I just want to talk in detail about some of the things I did in the past week on the project, and what I plan to do in the coming week.</p>

<h2 id="last-week">Last Week</h2>

<h3 id="writing">WRITING</h3>

<p>With my announcement last weekend that I’ll be building Stock Alerts in public, I was compelled to write a few extra posts to lay some of the groundwork for project. I wrote the <a href="https://blog.jonblankenship.com/2019/06/25/working-on-a-new-side-project-in-public/">introductory post</a>, spoke about <a href="https://blog.jonblankenship.com/2019/06/28/stock-alerts-features/">the features</a>, and laid out <a href="https://blog.jonblankenship.com/2019/07/01/stock-alerts-infrastructure/">the infrastructure</a>.</p>

<p>Naturally, this took some of my time away from development, but I think it was time well spent.</p>

<p>I have other posts that I want to write in the future to cover some of the work I’ve already done (particularly in the API), and I’ll try to work those in in the coming weeks without sacrificing too much dev time.</p>

<h3 id="create-alert-definition--stock-search">CREATE ALERT DEFINITION – STOCK SEARCH</h3>

<p>I’ve been working on the Create Alert Definition screen in the Stock Alerts mobile app. This is where the user defines an alert, including selecting the stock and defining the alert criteria. Specifically, I was focused on the stock selection functionality last week (we’ll talk more about building the alert criteria in a couple weeks).</p>

<p>Here’s a wireframe for these screens:</p>

<p><img src="Stock-Alerts-Create-Alert-Definition-screen-wireframes-768x360.png" alt="Stock Alerts Create Alert Definition screen wireframes" /></p>

<p>I want the stock search feature to function like a typeahead search, allowing the user to type as much or as little of the stock symbol or company name as desired, and when they pause, the system retrieves the search results.</p>

<p>I already had an API endpoint for finding stocks based on a search string; I just needed to add <code class="highlighter-rouge">CancellationToken</code> support, which was as simple as adding it to the Azure function signature and plumbing it down to the data access layer:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"FindStocks"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">HandleExceptions</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">FindStocksAsync</span><span class="p">(</span>
    <span class="p">[</span><span class="nf">HttpTrigger</span><span class="p">(</span><span class="n">AuthorizationLevel</span><span class="p">.</span><span class="n">Anonymous</span><span class="p">,</span> <span class="s">"get"</span><span class="p">,</span> <span class="n">Route</span> <span class="p">=</span> <span class="s">"stocks"</span><span class="p">)]</span> <span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">,</span>
    <span class="n">ILogger</span> <span class="n">log</span><span class="p">)</span>
</code></pre></div></div>

<p>Implementing search on the mobile app side took a bit more work…</p>

<p>Thinking about this from an implementation perspective, my <code class="highlighter-rouge">StockSearchPageViewModel</code> needs to have a <code class="highlighter-rouge">SearchString</code> property that receives the input from the textbox, waits a second, and if there’s no additional input, execute the web request to get the search results from the API, which will populate a collection of results on the view model to which the view is bound. If additional input is received from the user while the web request is executing, we need to cancel it and issue a new request.</p>

<p>I can’t (shouldn’t) implement all of this in the <code class="highlighter-rouge">SearchString</code> property setter, because you can’t (and shouldn’t want to) make a property setter async. Property setters should be fast and non-blocking. And yet I want to be able to simply bind the <code class="highlighter-rouge">Text</code> property of my search box to a property on my view model.</p>

<p>I ended up using <code class="highlighter-rouge">NotifyTask</code> from <a href="https://blog.stephencleary.com/">Stephen Cleary’s</a> <a href="https://www.nuget.org/packages/Nito.Mvvm.Async/">Nito.Mvvm.Async</a> library, which contains helpers for working with async methods in MVVM. <code class="highlighter-rouge">NotifyTask</code> is “essentially an <code class="highlighter-rouge">INotifyPropertyChanged</code> wrapper for <code class="highlighter-rouge">Task</code>/<code class="highlighter-rouge">Task&lt;T&gt;</code>,” as Stephen writes in <a href="https://stackoverflow.com/a/20953623/9688659">this SO answer</a>, which helped me quite a bit (the answer refers to <code class="highlighter-rouge">NotifyTaskCompletion</code>, which was replaced by <code class="highlighter-rouge">NotifyTask</code>).</p>

<p>So here’s my <code class="highlighter-rouge">StockSearchPageViewModel</code> implementation:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">StockSearchPageViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IStocksService</span> <span class="n">_stocksService</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">_searchCancellationTokenSource</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">StockSearchPageViewModel</span><span class="p">(</span>
        <span class="n">IStocksService</span> <span class="n">stocksService</span><span class="p">,</span>
        <span class="n">INavigationService</span> <span class="n">navigationService</span><span class="p">,</span> 
        <span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">navigationService</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_stocksService</span> <span class="p">=</span> <span class="n">stocksService</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">stocksService</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="n">_searchString</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">SearchString</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">_searchString</span><span class="p">;</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="n">_searchString</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">newSearchCancellationTokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_searchCancellationTokenSource</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">_searchCancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
            <span class="n">_searchCancellationTokenSource</span> <span class="p">=</span> <span class="n">newSearchCancellationTokenSource</span><span class="p">;</span>

            <span class="n">Stocks</span> <span class="p">=</span> <span class="n">NotifyTask</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nf">SearchStocksAsync</span><span class="p">(</span><span class="n">_searchCancellationTokenSource</span><span class="p">));</span>
            <span class="nf">RaisePropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">SearchString</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">NotifyTask</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Stock</span><span class="p">&gt;&gt;</span> <span class="n">_stocks</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">NotifyTask</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Stock</span><span class="p">&gt;&gt;</span> <span class="n">Stocks</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">_stocks</span><span class="p">;</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="n">_stocks</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="nf">RaisePropertyChanged</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Stocks</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Stock</span> <span class="n">_stock</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Stock</span> <span class="n">SelectedStock</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">_stock</span><span class="p">;</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="n">_stock</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">navigationParams</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NavigationParameters</span><span class="p">();</span>
            <span class="n">navigationParams</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">NavigationParameterKeys</span><span class="p">.</span><span class="n">SelectedStock</span><span class="p">,</span> <span class="n">_stock</span><span class="p">);</span>
            <span class="n">NavigationService</span><span class="p">.</span><span class="nf">GoBackAsync</span><span class="p">(</span><span class="n">navigationParams</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Stock</span><span class="p">&gt;&gt;</span> <span class="nf">SearchStocksAsync</span><span class="p">(</span><span class="n">CancellationTokenSource</span> <span class="n">searchCancellationTokenSource</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SearchString</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;=</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">searchCancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">searchCancellationTokenSource</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">stocks</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_stocksService</span><span class="p">.</span><span class="nf">FindStocksAsync</span><span class="p">(</span><span class="n">SearchString</span><span class="p">,</span> <span class="n">searchCancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">stocks</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="n">searchCancellationTokenSource</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                <span class="n">_searchCancellationTokenSource</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Stock</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The view model creates and manages the cancellation token source, and cancels it when necessary, in the <code class="highlighter-rouge">SearchString</code> property setter. This is also where we create the <code class="highlighter-rouge">NotifyTask</code>, passing it a delegate for the <code class="highlighter-rouge">SearchStocksAsync(..)</code> method, which delays one second and calls the search API. The results of the <code class="highlighter-rouge">SearchStocksAsync(..)</code> method call are exposed as <code class="highlighter-rouge">NotifyTask&lt;List&lt;Stock&gt;&gt;</code> by the <code class="highlighter-rouge">Stocks</code> property.</p>

<p>In my <code class="highlighter-rouge">StockSearchPage</code> view, I can simply bind to the properties, like so:</p>

<pre><code class="language-xaml">&lt;SearchBar Grid.Row="1" Placeholder="Start typing ticker or company name" Text="{Binding SearchString, Mode=TwoWay}"&gt;&lt;/SearchBar&gt;
&lt;ListView Grid.Row="2" ItemsSource="{Binding Stocks.Result}" SelectedItem="{Binding SelectedStock}"&gt;
    &lt;!--snip--&gt;
&lt;/ListView&gt;
</code></pre>

<p>… and with that, the typeahead stock search seems to be working pretty well.</p>

<h5 id="httpclientfactory">HTTPCLIENTFACTORY</h5>

<p>ASP.Net Core 2.1 introduced <code class="highlighter-rouge">HttpClientFactory</code>, which solves some of the problems developers run into when they create too many <code class="highlighter-rouge">HttpClient</code>s in their projects. Steven Gordon has a nice write-up on <code class="highlighter-rouge">HttpClientFactory</code> and the problems it attempts to solve <a href="https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore">here</a>.</p>

<p>The syntax to configure clients using <code class="highlighter-rouge">HttpClientFactory</code> is straightforward. In your ASP.NET Core Startup.cs:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddHttpClient</span><span class="p">(</span><span class="n">Apis</span><span class="p">.</span><span class="n">SomeApi</span><span class="p">,</span> <span class="n">c</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">c</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"https://api.someapi.com"</span><span class="p">);</span>
    <span class="n">c</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Accept"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Unfortunately, since Xamarin.Forms projects target .NET Standard, we can’t use any of the .NET Core goodies like <code class="highlighter-rouge">HttpClientFactory</code>. I wanted a similar pattern for configuring and creating my <code class="highlighter-rouge">HttpClient</code>s in the mobile app, so I took some inspiration from <a href="https://github.com/aspnet/Extensions/tree/master/src/HttpClientFactory/Http/src">here</a> and created my own poor man’s <code class="highlighter-rouge">HttpClientFactory</code>.</p>

<p>Here’s my <code class="highlighter-rouge">IHttpClientFactory</code> interface:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IHttpClientFactory</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">AddHttpClient</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">configurationAction</span><span class="p">);</span>

    <span class="n">HttpClient</span> <span class="nf">CreateClient</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s my fairly naïve, yet adequate implementation:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HttpClientFactory</span> <span class="p">:</span> <span class="n">IHttpClientFactory</span><span class="p">,</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;&gt;</span> <span class="n">_configurations</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;&gt;();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">_clients</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">HttpClient</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">AddHttpClient</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">configurationAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">$"</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">name</span><span class="p">)}</span><span class="s"> must be provided."</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_configurations</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">$"A client with the name </span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s"> has already been added."</span><span class="p">);</span>

        <span class="n">_configurations</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">configurationAction</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">HttpClient</span> <span class="nf">CreateClient</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">_clients</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_configurations</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">$"A client by the name of </span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s"> has not yet been registered.  Call </span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">AddHttpClient</span><span class="p">)}</span><span class="s"> first."</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
            <span class="n">_configurations</span><span class="p">[</span><span class="n">name</span><span class="p">].</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
            <span class="n">_clients</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">httpClient</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">_clients</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">c</span> <span class="k">in</span> <span class="n">_clients</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">c</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, the registration of the factory with a single client in my App.xaml.cs:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IHttpClientFactory</span> <span class="n">httpClientFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientFactory</span><span class="p">();</span>
<span class="n">httpClientFactory</span><span class="p">.</span><span class="nf">AddHttpClient</span><span class="p">(</span>
    <span class="n">MiscConstants</span><span class="p">.</span><span class="n">StockAlertsApi</span><span class="p">,</span> 
    <span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">MiscConstants</span><span class="p">.</span><span class="n">StockAlertsApiBaseUri</span><span class="p">);</span>
        <span class="n">c</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>
    <span class="p">});</span>
<span class="n">containerRegistry</span><span class="p">.</span><span class="nf">RegisterInstance</span><span class="p">(</span><span class="n">httpClientFactory</span><span class="p">);</span>
</code></pre></div></div>

<p>This gives me a nice way to create and manage my <code class="highlighter-rouge">HttpClient</code>s in my Xamarin.Forms project, and it will be easy to drop in the real <code class="highlighter-rouge">HttpClientFactory</code> if it ever becomes available for Xamarin.Forms projects.</p>

<hr />

<p>Last week’s activities also included implementing a web service client base class for handling common tasks when communicating with the API, storing access and refresh tokens on the client, and working out my unauthorized/refresh token flow, but those are topics for another post. This one’s long enough.</p>

<h2 id="this-week">This Week</h2>

<p>This week’s already about half over, and we’ve got the 4th of July coming up. I plan to continue working on the Create Alert Definition screen, and perhaps by the next time I write I’ll have the functionality for building the alert criteria and saving the alert definition working – we’ll see.</p>

<p>Here’s the repository for the project if you’d like to follow along: https://github.com/jonblankenship/stock-alerts.</p>

<p>Thanks for reading, and Happy Fourth of July!</p>

<p>-Jon</p>

      </div>
      
      <div class="post-footer">
          <ul class="post-tags">
          
            
            <li><a href="/tag/asp-net-core">asp-net-core</a></li>
          
            
            <li><a href="/tag/async-await">async-await</a></li>
          
            
            <li><a href="/tag/cancellation-token">cancellation-token</a></li>
          
            
            <li><a href="/tag/httpclient">httpclient</a></li>
          
            
            <li><a href="/tag/httpclientfactory">httpclientfactory</a></li>
          
            
            <li><a href="/tag/inotifypropertychanged">inotifypropertychanged</a></li>
          
            
            <li><a href="/tag/mvvm">mvvm</a></li>
          
            
            <li><a href="/tag/notifytask">notifytask</a></li>
          
            
            <li><a href="/tag/stock-alerts">stock-alerts</a></li>
          
            
            <li><a href="/tag/stock-alerts-update">stock-alerts-update</a></li>
          
            
            <li><a href="/tag/xamarin.forms">xamarin.forms</a></li>
          
          </ul>
      </div>

        <!-- Configure Disqus --></div>
  </main></body>
</html>