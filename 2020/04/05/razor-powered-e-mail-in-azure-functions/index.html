<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Razor-Powered E-mail in Azure Functions | Jon Blankenship</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Razor-Powered E-mail in Azure Functions" />
<meta name="author" content="Jon_Blankenship" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="On a couple of recent side projects I’ve had the need to send automated e-mails to my users. For both implementations I chose the same approach: use Razor templates combined with Azure Functions to build a simple, maintainable, and loosely-coupled solution for sending transactional e-mails. In this post I’ll show you how to do the same." />
<meta property="og:description" content="On a couple of recent side projects I’ve had the need to send automated e-mails to my users. For both implementations I chose the same approach: use Razor templates combined with Azure Functions to build a simple, maintainable, and loosely-coupled solution for sending transactional e-mails. In this post I’ll show you how to do the same." />
<link rel="canonical" href="https://blog.jonblankenship.com//2020/04/05/razor-powered-e-mail-in-azure-functions/" />
<meta property="og:url" content="https://blog.jonblankenship.com//2020/04/05/razor-powered-e-mail-in-azure-functions/" />
<meta property="og:site_name" content="Jon Blankenship" />
<meta property="og:image" content="https://blog.jonblankenship.com//2020/03/22/differentiating-yourself-from-the-competition/chess-piece.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-05T09:15:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://blog.jonblankenship.com//2020/04/05/razor-powered-e-mail-in-azure-functions/","headline":"Razor-Powered E-mail in Azure Functions","dateModified":"2020-04-05T09:15:00-05:00","datePublished":"2020-04-05T09:15:00-05:00","image":"https://blog.jonblankenship.com//2020/03/22/differentiating-yourself-from-the-competition/chess-piece.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.jonblankenship.com//2020/04/05/razor-powered-e-mail-in-azure-functions/"},"author":{"@type":"Person","name":"Jon_Blankenship"},"description":"On a couple of recent side projects I’ve had the need to send automated e-mails to my users. For both implementations I chose the same approach: use Razor templates combined with Azure Functions to build a simple, maintainable, and loosely-coupled solution for sending transactional e-mails. In this post I’ll show you how to do the same.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  







<!-- Twitter cards -->
<meta name="twitter:site"    content="@Jon_Blankenship">
<meta name="twitter:creator" content="@Jon_Blankenship">
<meta name="twitter:title"   content="Razor-Powered E-mail in Azure Functions">


<meta name="twitter:description" content="Developer.">



<meta name="twitter:card"  content="summary_large_image">
<meta name="twitter:image" content="https://blog.jonblankenship.com/2020/03/22/differentiating-yourself-from-the-competition/chess-piece.jpg">

<!-- end of Twitter cards -->


  <!-- Use $env:JEKYLL_ENV="production"; bundle exec jekyll build to build for production. -->
  <!-- Fathom - simple website analytics - https://usefathom.com -->
  <script>
      (function(f, a, t, h, o, m){
      a[h]=a[h]||function(){
          (a[h].q=a[h].q||[]).push(arguments)
      };
      o=f.createElement('script'),
      m=f.getElementsByTagName('script')[0];
      o.async=1; o.src=t; o.id='fathom-script';
      m.parentNode.insertBefore(o,m)
      })(document, window, '//cdn.usefathom.com/tracker.js', 'fathom');
      fathom('set', 'siteId', 'VHYCR');
      fathom('trackPageview');
  </script>
  <!-- / Fathom -->
</head>
<body>
  <header class="texture-black">
    <div class="container"></div><div class="container page-header post-header">
	<div class="site-title"><a href="/">Jon Blankenship</a></div>
	<h2>Developer.</h2>
</div>
	</header>
  <main>
    <div class="container">
      <div class="post-title">        
          <div class="post-date">
              Apr 5, 2020
            </div>
          <h1>Razor-Powered E-mail in Azure Functions</h1>
          <h4 class="post-description"></h4>
      </div>

      <div class="post-container">
          <p>On a couple of recent projects I’ve had the need to send automated e-mails to my users.  For both implementations I chose the same approach:  use <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/views/razor?view=aspnetcore-3.1">Razor</a> templates combined with <a href="https://docs.microsoft.com/en-us/azure/azure-functions/">Azure Functions</a> to build a simple, maintainable, and loosely-coupled solution for sending transactional e-mails.</p>

<p>In this post I’ll show you how to do the same.</p>

<p><img src="HighLevelFlow.png" alt="High-level flow" /></p>

<p>At a high level, here’s what happens when my application needs to send an e-mail:</p>

<ol>
  <li>Application code determines that an e-mail should be sent.</li>
  <li>Application code writes a message to an <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-queues-topics-subscriptions">Azure Service Bus</a> queue (<code class="highlighter-rouge">email-queue</code>).</li>
  <li>Azure Function (<code class="highlighter-rouge">email-queue-trigger-function</code>) receives message from Service Bus queue.</li>
  <li>Azure Function builds e-mail from a Razor template and a template model.</li>
  <li>Azure Function sends e-mail.</li>
</ol>

<p>For this post, I’ll focus on steps 3 through 5, the building and sending of the e-mail from an Azure Function.</p>

<h2 id="why-this-approach">Why This Approach?</h2>

<p>I like this approach for a couple of reasons.  Let’s talk about why I chose this path first, and then we’ll get into the code.</p>

<h3 id="azure-functions">Azure Functions</h3>

<p><img src="AzureFunctions.png" alt="Azure Functions" class="float-right" /></p>

<p>My application already uses Azure Functions for some of its processing, and my requirement is to automatically send a user an e-mail when certain conditions are met during the course of that processing.  Sending the e-mail is a side effect of the core domain processing - it should certainly happen, but I want it to happen in a separate process.  I consider the building and sending of e-mails as supporting application logic and not part of my domain logic.</p>

<p>Using a <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=csharp">Service Bus-triggered Azure Function</a> works nicely for this.  When the conditions are met that need to trigger an e-mail, the core process can simply enqueue the appropriate message on the e-mail Service Bus queue and continue with its work.  Fire and forget.</p>

<p><img src="ServiceBusQueue.png" alt="Service Bus Queue" class="float-right" /></p>

<p>The Service Bus queue is durable and reliable.  We can rest assured that once the message is on the queue, it won’t be lost.  The Service Bus-triggered Azure Function responsible for sending e-mails is invoked as soon as there is a message on the queue, and it starts its work building and sending the e-mail.  If there’s a failure in my receiving Azure Function or it’s down for some reason, the Service Bus queue will keep the message until it can be properly handled.</p>

<p>Isolating the e-mail sending logic in its own Azure Function offers a few benefits:</p>

<ol>
  <li>It promotes <a href="https://en.wikipedia.org/wiki/Loose_coupling">loose coupling</a>.</li>
  <li>It keeps the domain code focused and not concerned with supporting functions.</li>
  <li>It can be scaled independently from other functions.</li>
</ol>

<h3 id="razor-templates">Razor Templates</h3>

<p>Razor templates are particularly well-suited for defining the layout of an HTML-based e-mail.  Razor is a markup language used tor generating HTML from a Razor template combined with a C# object.</p>

<p>Razor allows you to define the body of your layout <a href="https://en.wikipedia.org/wiki/Declarative_programming">declaratively</a>, which is a natural programming paradigm for expressing a desired outcome, like a user interface, query result, file format, or, as in our case, an e-mail body.</p>

<p>I define a Razor e-mail template for each type of e-mail that my application needs to send.  Each template has a corresponding model class, representing the data that is needed to render that template.  When I need to render the template (to build the e-mail), I pass my template and an instance of the corresponding model class to a Razor rendering engine, and it returns the generated HTML as a string.</p>

<p>I much prefer this approach to building the e-mail body <a href="https://en.wikipedia.org/wiki/Imperative_programming">imperatively</a> by concatenating strings in C#!</p>

<p><img src="RazorCompilation.png" alt="Diagram showing compilation of Razor template and model to HTML" /></p>

<h2 id="prerequisites">Prerequisites</h2>

<p>There are a couple of prerequisites we’ll need in order to get our Azure Function sending e-mail:</p>

<ol>
  <li>
    <p>Razor Rendering Engine - I’m using the <a href="https://www.nuget.org/packages/RazorLight.Unofficial/2.0.0-beta1.3">RazorLight.Unofficial 2.0.0-beta1.3</a> package to generate my HTML from the Razor template and model.  It’s a pre-release package, but if that makes you squeamish there are other alternatives out there.</p>
  </li>
  <li>
    <p>Transactional E-mail Service - For my e-mail service I’m using <a href="https://www.mailgun.com/">Mailgun</a>, which I’ve been fairly happy with.  You can send e-mail via their HTTP API or by SMTP, and they offer many of the features that you’d expect from an enterprise e-mail service.</p>
  </li>
</ol>

<h2 id="implementation">Implementation</h2>

<p>Let’s dig into some code.  We’ll start by looking at the e-mail message that we’ll be sending.</p>

<h3 id="the-message">The Message</h3>

<h5 id="razor-template">Razor Template</h5>

<p>All of my e-mail templates live in a folder in my Functions project called <code class="highlighter-rouge">\EmailTemplates</code>.  In it there’s a Razor template named <code class="highlighter-rouge">NewExceptionGroupTemplate.cshtml</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@model ServiceTrace.Domain.Model.Email.NewExceptionGroupModel

&lt;h3&gt;@Model.Subject&lt;/h3&gt;

&lt;p&gt;To view the full exception details, click &lt;a href='@Model.Url'&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;div&gt;&lt;strong&gt;Message:&lt;/strong&gt; @Model.Message&lt;/div&gt;
&lt;div&gt;&lt;strong&gt;Time Occurred:&lt;/strong&gt; @Model.TimeOccurred.ToString("G") UTC&lt;/div&gt;
&lt;div&gt;&lt;strong&gt;Stack Trace:&lt;/strong&gt;&lt;/div&gt;
&lt;div&gt;
    &lt;pre&gt;&lt;code&gt;@Model.StackTrace&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
</code></pre></div></div>

<p><strong>Important:</strong>  Set the Build Action for all Razor email templates to <code class="highlighter-rouge">Embedded Resource</code> and the Copy to Output Directory to <code class="highlighter-rouge">Do not copy</code>.</p>

<p><img src="EmbeddedResourceProperties.png" alt="Razor template file properties" /></p>

<h5 id="template-model">Template Model</h5>

<p>The model that provides the data for this template is <code class="highlighter-rouge">NewExceptionGroupModel</code>.  It’s a <a href="https://en.wikipedia.org/wiki/Plain_old_CLR_object">POCO</a> that has properties for each of the data items that will be merged into the Razor template:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">NewExceptionGroupModel</span> <span class="p">:</span> <span class="n">IEmailTemplateModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">NewExceptionGroupModel</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="k">public</span> <span class="nf">NewExceptionGroupModel</span><span class="p">(</span><span class="n">ExceptionInstance</span> <span class="n">exceptionInstance</span><span class="p">,</span> <span class="n">IProject</span> <span class="n">project</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Subject</span> <span class="p">=</span> <span class="s">$"New exception thrown in </span><span class="p">{</span><span class="n">project</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">;</span> 
        <span class="n">Message</span> <span class="p">=</span> <span class="n">exceptionInstance</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
        <span class="n">TimeOccurred</span> <span class="p">=</span> <span class="n">exceptionInstance</span><span class="p">.</span><span class="n">TimeOccurred</span><span class="p">;</span>
        <span class="n">StackTrace</span> <span class="p">=</span> <span class="n">exceptionInstance</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">;</span>
        <span class="n">Url</span> <span class="p">=</span> <span class="n">exceptionInstance</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Subject</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 

    <span class="k">public</span> <span class="kt">string</span> <span class="n">TemplateName</span> <span class="p">=&gt;</span> <span class="s">"NewExceptionGroupTemplate"</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">DateTimeOffset</span> <span class="n">TimeOccurred</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">StackTrace</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, <code class="highlighter-rouge">IEmailTemplateModel</code> has a couple of properties that are common to all of my e-mail template models:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IEmailTemplateModel</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">Subject</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">string</span> <span class="n">TemplateName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">TemplateName</code> property identifies the Razor template that this model corresponds with.  It will be used to retrieve the appropriate Razor template when we’re ready to generate the HTML for the e-mail body.  The rest of the properties are data items that will be merged into the Razor template.</p>

<p>So that’s all that’s needed to define the e-mail message body - we’ll see how it gets turned into HTML in a moment…</p>

<h3 id="receive-the-message">Receive the Message</h3>

<p>I’m using a Service Bus queue, cleverly named <code class="highlighter-rouge">email-queue</code>, as the channel by which the rest of my application notifies my e-mail function that an e-mail needs to be sent.  To do this, the application creates a new <code class="highlighter-rouge">NewExceptionGroupModel</code> with the appropriate data and puts it on the queue with a couple of additional user properties:</p>

<ul>
  <li>EmailModelType - tells the e-mail function what type of model is in the queue message body.</li>
  <li>ToEmailAddress - tells the e-mail function who to send the e-mail to.  (I’ve made this a user property on the message, but there’s no reason why it couldn’t be defined on <code class="highlighter-rouge">IEmailTemplateModel</code> and be part of the model.)</li>
</ul>

<p>The function that responds to a new message on <code class="highlighter-rouge">email-queue</code> reads the user properties on the message and deserializes the message body into an instance of the appropriate e-mail template model, <code class="highlighter-rouge">NewExceptionGroupModel</code> in this case, and invokes <code class="highlighter-rouge">_emailSender.SendEmailAsync(..)</code> to build and send the e-mail:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"email-queue-trigger-function"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">ServiceBusTrigger</span><span class="p">(</span><span class="s">"email-queue"</span><span class="p">,</span> <span class="n">Connection</span> <span class="p">=</span> <span class="s">"ServiceBusConnectionString"</span><span class="p">)]</span> <span class="n">Message</span> <span class="n">message</span><span class="p">,</span> <span class="n">ILogger</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">ExcepticonSdk</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="n">_appSettings</span><span class="p">.</span><span class="n">ExcepticonOptions</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">EmailModelTypeKey</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">modelType</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">[</span><span class="n">EmailModelTypeKey</span><span class="p">].</span><span class="nf">ToString</span><span class="p">();</span>
                <span class="n">IEmailTemplateModel</span> <span class="n">emailModel</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">modelType</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="k">nameof</span><span class="p">(</span><span class="n">NewExceptionGroupModel</span><span class="p">):</span>
                        <span class="n">emailModel</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">NewExceptionGroupModel</span><span class="p">&gt;(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="c1">// handle other types of e-mails here</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">emailModel</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">_emailSender</span><span class="p">.</span><span class="nf">SendEmailAsync</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">[</span><span class="s">"EmailAddress"</span><span class="p">].</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">emailModel</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ExcepticonSdk</span><span class="p">.</span><span class="nf">CaptureException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>(Shameless plug:  I’ve wrapped my function body in a <code class="highlighter-rouge">try..catch</code> that sends any exceptions that occur to <a href="https://excepticon.io">Excepticon</a>, an exception monitoring service.  I built Excepticon and wrote about it in a <a href="https://blog.jonblankenship.com/2020/03/05/excepticon-exception-monitoring-for-dot-net/">previous post</a>.  Using Excepticon is certainly not required for the topic we’re discussing here, but if you’re looking for an exception monitoring service, I invite you to check it out.  Now, back to our program…)</p>

<h3 id="build-and-send">Build and Send</h3>

<p>The <code class="highlighter-rouge">EmailSender</code> instance is managed my IoC container and injected into the function.  The interface is straight-forward:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IEmailSender</span>
<span class="p">{</span>
    <span class="n">Task</span> <span class="nf">SendEmailAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">toAddress</span><span class="p">,</span> <span class="n">IEmailTemplateModel</span> <span class="n">templateModel</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The implementation of <code class="highlighter-rouge">IEmailSender.SendEmailAsync(..)</code> consists of rendering the e-mail template and corresponding model as a string of HTML, and then building the web request to <code class="highlighter-rouge">POST</code> to the Mailgun API:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">EmailSender</span> <span class="p">:</span> <span class="n">IEmailSender</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IAppSettings</span> <span class="n">_appSettings</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">RazorLightEngine</span> <span class="n">_razorLightEngine</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HttpClient</span> <span class="n">_httpClient</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">MailGunBaseUrl</span> <span class="p">=</span> <span class="s">"https://api.mailgun.net/v3"</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">EmailSender</span><span class="p">(</span><span class="n">IAppSettings</span> <span class="n">appSettings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_appSettings</span> <span class="p">=</span> <span class="n">appSettings</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">appSettings</span><span class="p">));</span>

        <span class="n">_razorLightEngine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RazorLightEngineBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">SetOperatingAssembly</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">())</span>
            <span class="p">.</span><span class="nf">UseEmbeddedResourcesProject</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Startup</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">UseMemoryCachingProvider</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

        <span class="n">_httpClient</span> <span class="p">=</span> <span class="nf">CreateHttpClient</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SendEmailAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">toAddress</span><span class="p">,</span> <span class="n">IEmailTemplateModel</span> <span class="n">templateModel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">emailBody</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">RenderEmailTemplateAsStringAsync</span><span class="p">(</span><span class="n">templateModel</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">requestContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FormUrlEncodedContent</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="s">"from"</span><span class="p">,</span> <span class="n">_appSettings</span><span class="p">.</span><span class="n">EmailSettings</span><span class="p">.</span><span class="n">SupportEmailAddress</span><span class="p">),</span>
            <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="s">"to"</span><span class="p">,</span> <span class="n">toAddress</span><span class="p">),</span>
            <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="s">"subject"</span><span class="p">,</span> <span class="n">templateModel</span><span class="p">.</span><span class="n">Subject</span><span class="p">),</span>
            <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="s">"html"</span><span class="p">,</span> <span class="n">emailBody</span><span class="p">)</span>
        <span class="p">});</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_appSettings</span><span class="p">.</span><span class="n">EmailSettings</span><span class="p">.</span><span class="n">Domain</span><span class="p">}</span><span class="s">/messages"</span><span class="p">,</span> <span class="n">requestContent</span><span class="p">);</span>
        <span class="n">result</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">RenderEmailTemplateAsStringAsync</span><span class="p">(</span><span class="n">IEmailTemplateModel</span> <span class="n">templateModel</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">templatePath</span> <span class="p">=</span> <span class="s">$"EmailTemplates.</span><span class="p">{</span><span class="n">templateModel</span><span class="p">.</span><span class="n">TemplateName</span><span class="p">}</span><span class="s">.cshtml"</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_razorLightEngine</span><span class="p">.</span><span class="nf">CompileRenderAsync</span><span class="p">(</span><span class="n">templatePath</span><span class="p">,</span> <span class="n">templateModel</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">HttpClient</span> <span class="nf">CreateHttpClient</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span> <span class="p">{</span> <span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">MailGunBaseUrl</span><span class="p">}</span><span class="s">/"</span><span class="p">)</span> <span class="p">};</span>
        <span class="kt">var</span> <span class="n">authHeader</span> <span class="p">=</span> <span class="s">$"api:</span><span class="p">{</span><span class="n">_appSettings</span><span class="p">.</span><span class="n">EmailSettings</span><span class="p">.</span><span class="n">MailGunApiKey</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
        <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">$"Bearer </span><span class="p">{</span><span class="n">authHeader</span><span class="p">.</span><span class="nf">Base64Encode</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">httpClient</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And that’s it!  Most of the heavy lifting is done by the <code class="highlighter-rouge">RazorLightEngine</code> and <code class="highlighter-rouge">Mailgun</code>.</p>

<h2 id="gotchas">Gotchas</h2>

<p>There are a few bumps I ran into along the way while trying to get this to work.  Hopefully this will save you some pain if you’re going down the same path.</p>

<ol>
  <li>
    <p><strong>Error compiling Razor when using the latest Microsoft.NET.Sdk.Functions package (3.0.5)</strong></p>

    <p>My call to <code class="highlighter-rouge">_razorLightEngine.ComplieRenderAsync(..)</code> was throwing the following error:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Could not load file or assembly 'System.IdentityModel.Tokens.Jwt, Version=5.6.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'
</code></pre></div>    </div>

    <p>This issue is documented <a href="https://github.com/Azure/azure-functions-host/issues/5756">here</a>.</p>

    <p>The workaround is to downgrade Microsoft.NET.Sdk.Functions to 3.0.3.</p>
  </li>
  <li>
    <p><strong>Project settings to support RazorLight rendering</strong></p>

    <p>There are a couple of settings you’ll probably have to set in your Azure Functions project file to enable the RazorLight rendering.  I had to set <code class="highlighter-rouge">PreserveCompilationReferences</code> and <code class="highlighter-rouge">PreserveCompilationContext</code> both to <code class="highlighter-rouge">true</code>:</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;PropertyGroup&gt;</span>
  <span class="nt">&lt;TargetFramework&gt;</span>netcoreapp3.0<span class="nt">&lt;/TargetFramework&gt;</span>
  <span class="nt">&lt;AzureFunctionsVersion&gt;</span>v2<span class="nt">&lt;/AzureFunctionsVersion&gt;</span>
  <span class="nt">&lt;PreserveCompilationReferences&gt;</span>true<span class="nt">&lt;/PreserveCompilationReferences&gt;</span>
  <span class="nt">&lt;PreserveCompilationContext&gt;</span>true<span class="nt">&lt;/PreserveCompilationContext&gt;</span>
<span class="nt">&lt;/PropertyGroup&gt;</span>
</code></pre></div>    </div>

    <p>The <a href="https://github.com/toddams/RazorLight">RazorLight project page</a> lists these and a couple of other project settings towards the bottom of the page that you may need to set depending on your circumstances.</p>

    <p>The two I mentioned above were the only ones I had to set.</p>
  </li>
  <li>
    <p><strong>“Mailgun Magnificent API” response</strong></p>

    <p>It took me a little trial and error to get my Mailgun API calls to succeed and actually send the e-mail.  For awhile I was getting a 200 response from the service, but the response body contained the string “Mailgun Magnificent API” and the e-mail wouldn’t send.</p>

    <p>According to a comment on <a href="https://stackoverflow.com/questions/46163664/765-unexpected-token-at-mailgun-magnificent-api-ruby-on-rails-mailgun-rails">this Stack Overflow question</a>, “‘Mailgun Magnificent API’ is Mailgun’s way of saying ‘Your sender domain and auth are all good, but I can’t figure out what API you’re asking for.”</p>

    <p>If you get this, I’d suggest inspecting the way I set my <code class="highlighter-rouge">_httpClient.BaseAddress</code> and how I build the URL for the <code class="highlighter-rouge">PostAsync(..)</code> call.  If you have a <code class="highlighter-rouge">/</code> in the wrong place, you’ll get this response.</p>
  </li>
</ol>

<p>Today we’ve seen why using Razor templates coupled with Azure Functions is a good approach to sending transactional e-mails from your application.  We’ve also seen how to implement this approach.</p>

<p>I hope it helps you if you’re considering going down the same path.</p>

          <p class="mt-4">– Jon</p>
          <p><em>I’m a developer and solo SaaS founder who likes to build things and share what I learn with others.  If you’re interested software development, launching things, or random early morning thoughts, consider <a href="https://twitter.com/Jon_Blankenship">following me</a> on Twitter or <a data-formkit-toggle="7e33ea9455" href="https://unique-designer-4037.ck.page/7e33ea9455">subscribe</a> to my newsletter.</em></p>
          <p class="mb-2"><em>Thanks for reading!</em></p><em>
      </div>
      
      <div class="post-footer">
          <ul class="post-tags">
          
            
            <li><a href="/tag/dotnet">dotnet</a></li>
          
            
            <li><a href="/tag/asp-net-core">asp-net-core</a></li>
          
            
            <li><a href="/tag/azure">azure</a></li>
          
            
            <li><a href="/tag/azure-functions">azure-functions</a></li>
          
            
            <li><a href="/tag/razor">razor</a></li>
          
            
            <li><a href="/tag/service-bus">service-bus</a></li>
          
            
            <li><a href="/tag/e-mail">e-mail</a></li>
          
            
            <li><a href="/tag/mailgun">mailgun</a></li>
          
            
            <li><a href="/tag/razorlight">razorlight</a></li>
          
          </ul>
      </div>

        <!-- Configure Disqus --></div>
  </main><script async data-uid="7e33ea9455" src="https://unique-designer-4037.ck.page/7e33ea9455/index.js"></script>
</body>
</html>